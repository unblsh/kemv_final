{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Operational Dashboard</h1>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">KPIs</div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="p-3 border rounded">
                            <h5>Today's Total Crimes</h5>
                            <h3 id="kpiTotalCrimes">...</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 border rounded">
                            <h5>Active Sectors (Today)</h5>
                            <h3 id="kpiActiveSectors">...</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 border rounded">
                            <h5>Most Reported Offense (Today)</h5>
                            <h3 id="kpiMostReportedOffense">...</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Crime Count by Hour of Day</div>
            <div class="card-body">
                <canvas id="crimeByHourChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Crime by Category: Today vs Yesterday</div>
            <div class="card-body">
                <canvas id="crimeTodayYesterdayChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Crime by Sector</div>
            <div class="card-body">
                <canvas id="crimeBySectorChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Daily Crime Totals (Last 7 Days)</div>
            <div class="card-body">
                <canvas id="dailyCrimeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">Last 50 Reported Crimes</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Report Number</th>
                                <th>Report DateTime</th>
                                <th>Offense Category</th>
                                <th>Precinct</th>
                                <th>Neighborhood</th>
                            </tr>
                        </thead>
                        <tbody id="recentCrimesTableBody">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/operational-data')
            .then(response => response.json())
            .then(data => {
                console.log('Operational Data:', data);
                // KPI Cards
                document.getElementById('kpiTotalCrimes').textContent = data.kpis.total_crimes_today;
                document.getElementById('kpiActiveSectors').textContent = data.kpis.active_sectors;
                document.getElementById('kpiMostReportedOffense').textContent = data.kpis.most_reported_offense_today || 'N/A';

                // Chart: Crime count by hour of day
                const crimeByHourCtx = document.getElementById('crimeByHourChart').getContext('2d');
                new Chart(crimeByHourCtx, {
                    type: 'line',
                    data: {
                        labels: data.crime_by_hour_chart.labels,
                        datasets: [{
                            label: 'Crime Count',
                            data: data.crime_by_hour_chart.values,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour of Day'
                                }
                            }
                        }
                    }
                });

                // Grouped Bar Chart: Crime by category today vs yesterday
                const crimeTodayYesterdayCtx = document.getElementById('crimeTodayYesterdayChart').getContext('2d');
                new Chart(crimeTodayYesterdayCtx, {
                    type: 'bar',
                    data: {
                        labels: data.crime_today_yesterday_chart.labels,
                        datasets: [
                            {
                                label: 'Today',
                                data: data.crime_today_yesterday_chart.today_values,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)'
                            },
                            {
                                label: 'Yesterday',
                                data: data.crime_today_yesterday_chart.yesterday_values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Chart: Crimes by sector
                const crimeBySectorCtx = document.getElementById('crimeBySectorChart').getContext('2d');
                new Chart(crimeBySectorCtx, {
                    type: 'bar',
                    data: {
                        labels: data.crime_by_sector_chart.labels,
                        datasets: [{
                            label: 'Crime Count',
                            data: data.crime_by_sector_chart.values,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Stacked Area Chart: Daily crime totals over last 7 days
                const dailyCrimeCtx = document.getElementById('dailyCrimeChart').getContext('2d');
                new Chart(dailyCrimeCtx, {
                    type: 'line',
                    data: {
                        labels: data.daily_crime_chart.labels,
                        datasets: [{
                            label: 'Daily Crime Total',
                            data: data.daily_crime_chart.values,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                stacked: true
                            },
                            x: {
                                stacked: true
                            }
                        }
                    }
                });

                // Live Table: Last 50 reported crimes
                const recentCrimesTableBody = document.getElementById('recentCrimesTableBody');
                data.recent_crimes.forEach(crime => {
                    const row = recentCrimesTableBody.insertRow();
                    row.insertCell().textContent = crime.Report_Number;
                    row.insertCell().textContent = crime.Report_DateTime;
                    row.insertCell().textContent = crime.Offense_Category;
                    row.insertCell().textContent = crime.Precinct;
                    row.insertCell().textContent = crime.Neighborhood;
                });
            })
            .catch(error => console.error('Error fetching operational data:', error));
    });
</script>
{% endblock %} 